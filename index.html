<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>POC - Leaflet</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="assets/MarkerCluster.css" />
    <link rel="stylesheet" href="assets/MarkerCluster.Default.css" />
    <script src="assets/leaflet.markercluster.js"></script>

    <!-- Leaflet contextmenu (clique droit) -->
    <link rel="stylesheet" href="assets/leaflet.contextmenu.css" />
    <script src="assets/leaflet.contextmenu.js"></script>

    <link rel="stylesheet" href="assets/custom.css" />

    <!-- Import bootstrap 3 with CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

</head>
<body>

<div id="leafletMap" style="width: 100%; height: 600px;"></div>


<!-- Modal Bootstrap 3 - Add Marker -->
<div class="modal fade" id="modalAddMarker" tabindex="-1" role="dialog" aria-labelledby="modalBootstrap3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modalBootstrap3Label">Add Marker</h4>
            </div>
            <div class="modal-body">
                <!-- Form (type: OxBase or Sensor, name, description, mac addr, address, city, postal code, country) -->
                <form id="addMarkerForm"></form>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select class="form-control" id="type">
                            <option value="OxBase">OxBase</option>
                            <option value="Sensor">Sensor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Ox-Base Bat A" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" class="form-control" id="description" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <label for="macAddr">MAC Addr</label>
                        <input type="text" class="form-control" id="macAddr" placeholder="FA:4C:77:XX:XX:XX" required>
                    </div>

                    <div class="form-group">
                        <label for="lat">Latitude</label>
                        <input type="number" class="form-control" id="lat" placeholder="Latitude" required>
                    </div>

                    <div class="form-group">
                        <label for="lng">Longitude</label>
                        <input type="number" class="form-control" id="lng" placeholder="Longitude" required>
                    </div>

                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" placeholder="13 rue antoine lavoisier">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" class="form-control" id="city" placeholder="Plaisance-du-Touch">
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal Code</label>
                        <input type="text" class="form-control" id="postalCode" placeholder="31830">
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" class="form-control" id="country" placeholder="France">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <input type="submit" form="addMarkerForm" class="btn btn-primary" value="Add" />
            </div>
        </div>
    </div>
</div>

<script type="module">
    /*
        * Leaflet : https://leafletjs.com/
        * MarkerCluster : https://github.com/Leaflet/Leaflet.markercluster/tree/master
        * Context menu : https://github.com/aratcliffe/Leaflet.contextmenu`
        * Récpérer adresse depuis des coordonnées : https://nominatim.org/
     */
    import Markers from './Markers.js';

    class LeafletMap {
        constructor(markers = []) {
            this.MAP = null;
            this.MARKER_CLUSTER_GROUP = L.markerClusterGroup();
            this.MARKERS = markers;

            this.DEFAULT_COORDINATES = [46.2046, 6.1565];
            this.DEFAULT_ZOOM = 13;

            this.TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

             this.initLeafletMap();

            this.displayMarkerCluster();
        }

        /**
         * Initialise la carte Leaflet
         * @return {void}
         */
        initLeafletMap() {
            const mapOptions = {
                contextmenu: true,
                contextmenuWidth: 150,
                contextmenuItems: [{
                    text: 'Add marker with modal',
                    callback: (e) => {
                        this.displayAndPopulateModal(e.latlng.lat, e.latlng.lng);
                    }
                },{
                    text: 'Add marker',
                    callback: function (e) {
                        const marker = L.marker(e.latlng, {
                            title: 'New marker',
                            description: 'This is a new marker',
                        });
                        marker.addTo(map);
                    }
                }, {
                    text: 'Center map here',
                    callback: function (e) {
                        map.panTo(e.latlng);
                    }
                },{
                    text: 'Zoom in',
                    callback: function (e) {
                        map.zoomIn();
                    }
                },{
                    text: 'Zoom out',
                    callback: function (e) {
                        map.zoomOut();
                    }
                },{
                    text: 'Show coordinates',
                    callback: function (e) {
                        alert(e.latlng.toString());
                    }
                }]
            };

            const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

            this.MAP = L.map('leafletMap', mapOptions).setView(this.DEFAULT_COORDINATES, this.DEFAULT_ZOOM);
            L.tileLayer(this.TILE_URL, {
                attribution
            }).addTo(this.MAP);
        }

        displayMarkerCluster() {
            this.MARKER_CLUSTER_GROUP.clearLayers();
            const markers = this.getMarkers();
            markers.forEach(marker => {
                const markerLatLng = new L.LatLng(marker.lat, marker.lng);
                const markerMarker = L.marker(markerLatLng);
                markerMarker.bindPopup(`<h3>${marker.title}</h3>${marker.description}`);
                this.MARKER_CLUSTER_GROUP.addLayer(markerMarker);
                this.MAP.addLayer(this.MARKER_CLUSTER_GROUP);
                console.log(marker.title);
            });
        }

        async getCoordinates(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${address}&format=json`;
            const answer = await fetch(url);
            if(answer.ok) {
                const data = await answer.json();
                return data[0];
            }
        }

        async getAddressFromCoordinates(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
            const answer = await fetch(url);
            if(answer.ok) {
                return await answer.json();
            }
        }

        // TODO: A modifier pour récupérer les markers depuis la base de données
        getMarkers() {
            return this.MARKERS;
        }

        async displayAndPopulateModal(lat, lng) {
            const modal = $('#modalAddMarker');
            modal.modal('show');
            const addressDatas = await this.getAddressFromCoordinates(lat, lng);
            console.log(addressDatas);
            document.querySelector('#address').value = addressDatas.address.road;
            document.querySelector(`#city`).value = addressDatas.address.city;
            document.querySelector(`#postalCode`).value = addressDatas.address.postcode;
            document.querySelector(`#country`).value = addressDatas.address.country;


            document.querySelector(`#lat`).value = lat;
            document.querySelector(`#lat`).disabled = true;
            document.querySelector(`#lng`).value = lng;
            document.querySelector(`#lng`).disabled = true;


            // Submit and add marker
            const classThis = this;
            document.querySelector(`#addMarkerForm`).addEventListener('submit', function submitModal (e) {
                e.preventDefault();

                const modal = $('#modalAddMarker');
                modal.modal('hide');

                const datas = {
                    name: document.querySelector('#name').value,
                    title: document.querySelector('#name').value,
                    description: document.querySelector('#description').value,
                    lat: document.querySelector('#lat').value,
                    lng: document.querySelector('#lng').value,
                    address: document.querySelector('#address').value,
                    city: document.querySelector('#city').value,
                    postalCode: document.querySelector('#postalCode').value,
                    country: document.querySelector('#country').value,
                };

                classThis.MARKERS.push(datas);
                classThis.displayMarkerCluster();

                console.log(this);
                this.removeEventListener('click', submitModal);
            });
        }

    }

    const currentMap = new LeafletMap(Markers);

</script>
</body>
</html>
