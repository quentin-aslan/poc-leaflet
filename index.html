<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>POC - Leaflet</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="assets/MarkerCluster.css" />
    <link rel="stylesheet" href="assets/MarkerCluster.Default.css" />
    <script src="assets/leaflet.markercluster.js"></script>

    <!-- Leaflet contextmenu (clique droit) -->
    <link rel="stylesheet" href="assets/leaflet.contextmenu.css" />
    <script src="assets/leaflet.contextmenu.js"></script>

    <link rel="stylesheet" href="assets/custom.css" />

    <!-- Import bootstrap 3 with CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Import zTree library -->
    <link rel="stylesheet" href="assets/zTree/zTreeStyle.css" type="text/css">
    <script type="text/javascript" src="assets/zTree/jquery.ztree.core.js"></script>

</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1>POC - Leaflet</h1>
        </div>
    </div>
    <div class="row">

        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Tree view</h3>
                </div>

                <div class="panel-body">
                    <ul id="tree" class="ztree" style="width:250px; overflzow:auto"></ul>
                </div>

                <div class="panel-footer text-right">
                    <button type="button" class="btn btn-success" id="btn-add-node">Add OxBase</button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="leafletMap" style="width: 100%; height: 600px;"></div>
        </div>
    </div>
</div>

<!-- Modal Bootstrap 3 - Add Marker -->
<div class="modal fade" id="modalAddMarker" tabindex="-1" role="dialog" aria-labelledby="modalBootstrap3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modalBootstrap3Label">Add Marker</h4>
            </div>
            <div class="modal-body">
                <!-- Form (type: OxBase or Sensor, name, description, mac addr, address, city, postal code, country) -->
                <form id="addMarkerForm"></form>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select class="form-control" id="type">
                            <option value="OxBase" selected>OxBase</option>
                            <option value="Sensor">Sensor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Ox-Base Bat A" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" class="form-control" id="description" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <label for="macAddr">MAC Addr</label>
                        <input type="text" class="form-control" id="macAddr" placeholder="FA:4C:77:XX:XX:XX" required>
                    </div>

                    <div class="form-group">
                        <label for="lat">Latitude</label>
                        <input type="number" class="form-control" id="lat" placeholder="Latitude" required>
                    </div>

                    <div class="form-group">
                        <label for="lng">Longitude</label>
                        <input type="number" class="form-control" id="lng" placeholder="Longitude" required>
                    </div>

                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" placeholder="13 rue antoine lavoisier">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" class="form-control" id="city" placeholder="Plaisance-du-Touch">
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal Code</label>
                        <input type="text" class="form-control" id="postalCode" placeholder="31830">
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" class="form-control" id="country" placeholder="France">
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <input type="submit" form="addMarkerForm" class="btn btn-primary" value="Add" />
            </div>
        </div>
    </div>
</div>

<script type="module">
    /*
        * Leaflet : https://leafletjs.com/
        * MarkerCluster : https://github.com/Leaflet/Leaflet.markercluster/tree/master
        * Context menu : https://github.com/aratcliffe/Leaflet.contextmenu`
        * Récpérer adresse depuis des coordonnées : https://nominatim.org/
     */

    class TreeView {

        /**
         * Cette class gère l'arbre situé à droite de la carte.
         * https://treejs.cn/v3/api.php
         * @param LeafletMap
         */

        constructor(LeafletMap) {
            this.LeafletMap = LeafletMap;
            this.LeafletMap.TreeView = this; // On passe la référence de la classe TreeView à la LeafletMap

            this.tree = null;

            this.TREE_DOM = $("#tree"); // On utilise jQuery pour récupérer le DOM de l'arbre

            this.zTreeObj = null;

            this.initTreeView();
        }

        onClickNode(event, treeId, treeNode) {
            if(!treeNode.lat || !treeNode.lng) {
                alert("No coordinates for this node, please add coordinates.");
                return;
            }

            this.LeafletMap.MAP.closePopup(); // On ferme le popup si il est ouvert
            this.LeafletMap.centerOnMarker(treeNode);
        }

        addIcon(markers) {
            for(let marker of markers) {
                marker.icon = "assets/images/ox_base_lora_16x16.png";
                if(!marker.lat || !marker.lng) {
                    marker.font = {color: "red"};
                }
            }
            return markers;
        }

        /**
         * Initialisation de l'arbre
         * @private
         */
        initTreeView() {
            const setting = {
                view: {
                    dblClickExpand: false,
                    showLine: true,
                    selectedMulti: false,
                    nameIsHTML: true,
                    fontCss: (treeId, treeNode) => {
                        if(treeNode.font) {
                            return treeNode.font;
                        }
                    }
                },
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pId",
                        rootPId: ""
                    }
                },
                callback: {
                    onClick: ((event, treeId, treeNode) => this.onClickNode(event, treeId, treeNode))
                },
            };
            $.fn.zTree.init(this.TREE_DOM, setting, this.addIcon(this.LeafletMap.MARKERS)); // Initialise l'arbre avec les données
            this.zTreeObj = $.fn.zTree.getZTreeObj("tree");
            this.zTreeObj.selectNode(this.zTreeObj.getNodeByParam("id", 103));
        }

        /**
         * Sélectionne un node de l'arbre
         * @param {object} node
         * @public
         */
        selectNode(node) {
            let treeObj = $.fn.zTree.getZTreeObj("tree");
            let allNodes = treeObj.getNodes();
            allNodes = treeObj.transformToArray(allNodes);

            const nodeInstance = allNodes.find(e => parseInt(e.id) === parseInt(node.id));
            if(nodeInstance) {
                treeObj.selectNode(nodeInstance);
            } else {
                console.log('node not found');
                return false;
            }
        }

    }

    class LeafletMap {
        /**
         * Cette class gère la carte à droite de l'arbre
         * @param markers
         */
        constructor(markers = []) {
            this.MAP = null;
            this.MARKER_CLUSTER_GROUP = L.markerClusterGroup();
            this.MARKERS = markers;

            this.DEFAULT_COORDINATES = [46.2046, 6.1565];
            this.DEFAULT_ZOOM = 13;

            this.TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

            this.API_URL = "http://localhost:8888/index.php";

            this.TreeView = null; // Instance de la class TreeView

            this.initLeafletMap();

            this.displayMarkerCluster();
        }

        /**
         * Initialise la carte Leaflet
         * @return {void}
         */
        initLeafletMap() {
            const LeafletMap = this;
            const mapOptions = {
                contextmenu: true,
                contextmenuWidth: 150,
                contextmenuItems: [{
                    text: 'Add marker with modal',
                    callback(e) {
                        LeafletMap.displayAndPopulateModal(e.latlng.lat, e.latlng.lng);
                    }
                }, {
                    text: 'Center map here',
                    callback(e) {
                        LeafletMap.MAP.panTo(e.latlng);
                    }
                },{
                    text: 'Zoom in',
                    callback(e) {
                        console.log(this);
                        LeafletMap.MAP.zoomIn();
                    }
                },{
                    text: 'Zoom out',
                    callback(e) {
                        LeafletMap.MAP.zoomOut();
                    }
                },{
                    text: 'Show coordinates',
                    callback(e) {
                        console.log(e);
                        alert(e.latlng.toString());
                    }
                }]
            };

            const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

            this.MAP = L.map('leafletMap', mapOptions).setView(this.DEFAULT_COORDINATES, this.DEFAULT_ZOOM);
            L.tileLayer(this.TILE_URL, {
                attribution
            }).addTo(this.MAP);
        }

        async displayMarkerCluster() {
            this.MARKER_CLUSTER_GROUP.clearLayers();
            for(const marker of this.MARKERS) {
                // If marker has no coordinates, we don't add it to the map
                if(!marker.lat || !marker.lng) {
                    continue;
                }

                const markerLatLng = new L.LatLng(marker.lat, marker.lng);
                const icon = (marker.type === 'OxBase') ? 'img/oxbase.png' : 'img/sensor.png';

                marker.icon = this.getOxBaseIcon();

                const LMarker = L.marker(markerLatLng, marker);
                LMarker.bindPopup(`
                    <h4>${marker.name}</h4>

                    <p>${marker.type}</p>

                    <p>${marker.lat}</p>

                    <p>${marker.lng}</p>
                `);

                LMarker.on('click', (e) => {
                    this.TreeView.selectNode(marker);
                    this.centerOnMarker(marker);
                });

                this.MARKER_CLUSTER_GROUP.addLayer(LMarker);
                this.MAP.addLayer(this.MARKER_CLUSTER_GROUP);
            }
        }

        getOxBaseIcon() {
            // Use the Leaflet icon class to create an icon from the png file
            return L.icon({
                iconUrl: 'assets/images/ox_base_lora_400x400.png',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -37]
            })
        }

        async getCoordinates(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${address}&format=json`;
            const answer = await fetch(url);
            if(answer.ok) {
                const data = await answer.json();
                return data[0];
            }
        }

        async getAddressFromCoordinates(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
            const answer = await fetch(url);
            if(answer.ok) {
                return await answer.json();
            }
        }

        async displayAndPopulateModal(lat, lng) {
            const modal = $('#modalAddMarker');
            modal.modal('show');
            const addressDatas = await this.getAddressFromCoordinates(lat, lng);

            document.querySelector(`#name`).value = "";
            document.querySelector(`#description`).value = "";
            document.querySelector(`#macAddr`).value = "";

            document.querySelector('#address').value = (addressDatas.address.road) ? addressDatas.address.road : "";
            document.querySelector(`#city`).value = (addressDatas.address.city) ? addressDatas.address.city : "";
            document.querySelector(`#postalCode`).value = (addressDatas.address.postcode) ? addressDatas.address.postcode : "";
            document.querySelector(`#country`).value = (addressDatas.address.country) ? addressDatas.address.country : "";


            document.querySelector(`#lat`).value = lat;
            document.querySelector(`#lat`).disabled = true;
            document.querySelector(`#lng`).value = lng;
            document.querySelector(`#lng`).disabled = true;


            // Submit and add marker
            const classThis = this;
            document.querySelector(`#addMarkerForm`).addEventListener('submit', function submitModal (e) {
                e.preventDefault();

                const modal = $('#modalAddMarker');
                modal.modal('hide');

                const datas = {
                    type: document.querySelector('#type').value,
                    name: document.querySelector('#name').value,
                    title: document.querySelector('#name').value,
                    description: document.querySelector('#description').value,
                    lat: document.querySelector('#lat').value,
                    lng: document.querySelector('#lng').value,
                    address: document.querySelector('#address').value,
                    city: document.querySelector('#city').value,
                    postalCode: document.querySelector('#postalCode').value,
                    country: document.querySelector('#country').value,
                };

                classThis.MARKERS.push(datas);
                classThis.displayMarkerCluster();

                classThis.insertOxBaseInDB(datas);

                this.removeEventListener('click', submitModal);
            });
        }

        /**
         * Centre la carte sur la position du marker
         * * @param {object} marker
         */
        centerOnMarker(marker) {
            const coords = new L.LatLng(marker.lat, marker.lng)

            const markerInstance = this._getMarkerInstance(marker.id);
            markerInstance.openPopup();

            console.log("Centering on marker");

            // center map view
            this.MAP.setView(coords, this.DEFAULT_ZOOM);
        }

        async getAllOxBaseInDB() {
            const url = `${this.API_URL}?API=getAllOxBase`;
            const answer = await fetch(url);
            if(answer.ok) {
                const all = await answer.json();
                all.forEach(OxBaseDatas => {
                    OxBaseDatas.title = OxBaseDatas.name;
                });

                return all;
            }
        }

        async insertOxBaseInDB(datas) {
            const url = `${this.API_URL}`;

            datas.API = "insertOxBase";

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datas)
            }

            const answer = await fetch(url, options);
            return answer.ok;
        }

        async updateOxBaseInDB(datas) {
            const url = `${this.API_URL}`;

            datas.API = "updateOxBase";

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datas)
            }

            const answer = await fetch(url, options);
            return answer.ok;
        }

        async deleteOxBaseInDB(datas) {
            const url = `${this.API_URL}`;

            datas.API = "deleteOxBase";

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datas)
            }

            const answer = await fetch(url, options);
            return answer.ok;
        }

        /**
         * Get specific marker from marker cluster leaflet
         * @private
         * @return {object|null} marker instance
         */
        _getMarkerInstance(id) {
            let markerInstance;
            this.MARKER_CLUSTER_GROUP.eachLayer((marker) => {
                if(marker.options.id === id) {
                    markerInstance = marker;
                    // On ne peut pas return ou break ..
                }
            });
            return (markerInstance) ? markerInstance : null;
        }
    }

    const defaultMarkers = [{
        id: 0,
        type: 'OxBase',
        name: 'OxBase',
        title: 'OxBase',
        description: 'OxBase',
        lat: 46.2046,
        lng: 6.1565,
        address: '',
        city: '',
        postalCode: '',
        country: ''
    }, {
        id: 1,
        type: 'OxBase',
        name: 'OxBase',
        title: 'OxBase',
        description: 'OxBase',
        lat: 46.2046,
        lng: 6.1565,
        address: '',
        city: '',
        postalCode: '',
        country: ''
    },{
        id: 2,
        type: 'OxBase',
        name: 'OxBase',
        title: 'OxBase',
        description: 'OxBase',
        lat: 46.2046,
        lng: 6.1565,
        address: '',
        city: '',
        postalCode: '',
        country: ''
    },{
        id: 3,
        pId: 0,
        type: 'OxBase',
        name: 'OxBase',
        title: 'OxBase',
        description: 'OxBase',
        lat: 46.2046,
        lng: 6.2565,
        address: '',
        city: '',
        postalCode: '',
        country: ''
    },{
        id: 4,
        pId: 0,
        type: 'OxBase sans coords',
        name: 'OxBase',
        title: 'OxBase',
        description: 'OxBase',
        lat: null,
        lng: null,
        address: '',
        city: '',
        postalCode: '',
        country: ''
    }];

    const LeafletMapInstance = new LeafletMap(defaultMarkers);
    const TreeViewInstance = new TreeView(LeafletMapInstance);

</script>
</body>
</html>
